<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.community.mbti.mapper.BoardMapper">

    <!-- 관계 MBTI 목록 조회 -->
    <select id="selectRelatedMbtis" resultType="String">
        /* selectRelatedMbtis */
        SELECT mbti_to
        FROM MBTI_RELATIONS
        WHERE mbti_from = #{mbtiFrom}
          AND relation_type = #{relationType}
    </select>

    <!-- 전체 게시물 수 조회 -->
    <select id="selectBoardCount" resultType="int" parameterType="map">
        /* selectBoardCount */
        SELECT COUNT(*)
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
    </select>

    <!-- 최신 게시물 목록 조회 (페이징) -->
    <select id="selectBoardList" resultType="com.community.mbti.vo.BoardVO" parameterType="map">
        /* selectBoardList */
        SELECT *
        FROM (
        SELECT ROWNUM AS rn, b.*
        FROM (
        SELECT boardno, title, member_mid, wrdate, recommendation, count, mbti_idx
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
        ORDER BY boardno DESC
        ) b
        )
        WHERE rn BETWEEN #{paging.startNum} AND #{paging.endNum}
    </select>

    <!-- 인기 게시물 목록 조회 (상위 5개) -->
    <select id="selectPopBoardList" resultType="com.community.mbti.vo.BoardVO" parameterType="map">
        /* selectPopBoardList */
        SELECT *
        FROM (
        SELECT boardno, title, member_mid, wrdate, recommendation, count, mbti_idx
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
        ORDER BY recommendation DESC, count DESC
        )
        WHERE ROWNUM &lt;= 5
    </select>

    <!-- 홈 화면용 최신글 조회 -->
    <select id="selectLatestBoards" resultType="com.community.mbti.vo.BoardVO">
        /* selectLatestBoards */
        SELECT *
        FROM (
                 SELECT boardno, title, wrdate, member_mid
                 FROM BOARD
                 WHERE viewcheck = 'Y'
                   AND mbti_idx = #{mbtiIdx}
                 ORDER BY wrdate DESC
             )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <!-- 홈 화면용 인기글 조회 -->
    <select id="selectPopularBoards" resultType="com.community.mbti.vo.BoardVO">
        /* selectPopularBoards */
        SELECT *
        FROM (
                 SELECT boardno, title, recommendation, member_mid
                 FROM BOARD
                 WHERE viewcheck = 'Y'
                   AND mbti_idx = #{mbtiIdx}
                 ORDER BY recommendation DESC
             )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insertBoard" parameterType="com.community.mbti.vo.BoardVO">
        /* insertBoard */
        INSERT INTO BOARD (
            boardno,
            title,
            content,
            member_mid,
            category,
            mbti_idx
        ) VALUES (
                     BOARD_SEQ.NEXTVAL,
                     #{title},
                     #{content},
                     #{memberMid},
                     #{category},
                     #{mbtiIdx}
                 )
    </insert>

    <!-- [추가] 조회수 1 증가 -->
    <update id="updateViewCount" parameterType="int">
        /* updateViewCount */
        UPDATE BOARD
        SET count = count + 1
        WHERE boardno = #{boardno}
    </update>

    <!-- [추가] 특정 게시물 1건 조회 -->
    <select id="selectBoardByNo" parameterType="int" resultType="com.community.mbti.vo.BoardVO">
        /* selectBoardByNo */
        SELECT *
        FROM BOARD
        WHERE boardno = #{boardno}
    </select>

    <!-- [추가] 특정 게시물의 댓글 목록 조회 -->
    <select id="selectCommentsByBoardNo" parameterType="int" resultType="com.community.mbti.vo.CommentsVO">
        /* selectCommentsByBoardNo */
        SELECT *
        FROM COMMENTS
        WHERE board_boardno = #{boardno}
        ORDER BY NVL(mgrno, commentno), wrdate
    </select>

    <!-- [추가] 특정 게시물의 사진 목록 조회 -->
    <select id="selectPicturesByBoardNo" parameterType="int" resultType="com.community.mbti.vo.PictureVO">
        /* selectPicturesByBoardNo */
        SELECT *
        FROM PICTURE
        WHERE board_boardno = #{boardno}
    </select>

</mapper>