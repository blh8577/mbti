<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.community.mbti.mapper.BoardMapper">

    <!-- 관계 MBTI 목록 조회 -->
    <select id="selectRelatedMbtis" resultType="String">
        /* selectRelatedMbtis */
        SELECT mbti_to
        FROM MBTI_RELATIONS
        WHERE mbti_from = #{mbtiFrom}
          AND relation_type = #{relationType}
    </select>

    <!-- 전체 게시물 수 조회 -->
    <select id="selectBoardCount" resultType="int">
        /* selectBoardCount */
        SELECT COUNT(*)
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
    </select>

    <!-- 최신 게시물 목록 조회 (페이징) -->
    <select id="selectBoardList" resultType="com.community.mbti.vo.BoardVO">
        /* selectBoardList */
        SELECT *
        FROM (
        SELECT ROWNUM AS rn, b.*
        FROM (
        SELECT boardno, title, member_mid, wrdate, recommendation, count, mbti_idx
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
        ORDER BY boardno DESC
        ) b
        )
        WHERE rn BETWEEN #{paging.startNum} AND #{paging.endNum}
    </select>

    <!-- 인기 게시물 목록 조회 (상위 5개) -->
    <select id="selectPopBoardList" resultType="com.community.mbti.vo.BoardVO">
        /* selectPopBoardList */
        SELECT *
        FROM (
        SELECT boardno, title, member_mid, wrdate, recommendation, count, mbti_idx
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND category = #{category}
        <if test="mbtiList != null and !mbtiList.isEmpty()">
            AND mbti_idx IN
            <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                #{mbti}
            </foreach>
        </if>
        ORDER BY recommendation DESC, count DESC
        )
        WHERE ROWNUM &lt;= 5
    </select>

    <!-- [수정] 홈 화면용 최신글 조회 - MBTI 관계 기반 필터링 추가 -->
    <select id="selectLatestBoards" resultType="com.community.mbti.vo.BoardVO">
        /* selectLatestBoards */
        SELECT *
        FROM (
                 SELECT
                     boardno, title, wrdate, member_mid, category
                 FROM
                     BOARD
                 WHERE
                     viewcheck = 'Y'
                   AND (
                     mbti_idx = #{mbtiIdx} -- 본인 MBTI 게시물
                         OR (category = 1 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'relation_good'))
                         OR (category = 2 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'relation_bad'))
                         OR (category = 3 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'love_good'))
                         OR (category = 4 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'love_bad'))
                     )
                 ORDER BY
                     wrdate DESC
             )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <!-- 홈 화면용 인기글 조회 -->
    <select id="selectPopularBoards" resultType="com.community.mbti.vo.BoardVO">
        /* selectPopularBoards */
        SELECT *
        FROM (
                 SELECT boardno, title, recommendation, member_mid
                 FROM BOARD
                 WHERE viewcheck = 'Y'
                   AND mbti_idx = #{mbtiIdx}
                 ORDER BY recommendation DESC
             )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insertBoard" parameterType="com.community.mbti.vo.BoardVO">
        /* insertBoard */
        <selectKey keyProperty="boardno" resultType="int" order="BEFORE">
            SELECT BOARD_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO BOARD (
        boardno, title, content, member_mid, category, mbti_idx
        ) VALUES (
        #{boardno}, #{title}, #{content}, #{memberMid}, #{category}, #{mbtiIdx}
        )
    </insert>

    <!-- [추가] 조회수 1 증가 -->
    <update id="updateViewCount" parameterType="int">
        /* updateViewCount */
        UPDATE BOARD
        SET count = count + 1
        WHERE boardno = #{boardno}
    </update>

    <!-- [추가] 특정 게시물 1건 조회 -->
    <select id="selectBoardByNo" parameterType="int" resultType="com.community.mbti.vo.BoardVO">
        /* selectBoardByNo */
        SELECT *
        FROM BOARD
        WHERE boardno = #{boardno}
    </select>

    <!-- [수정] Oracle의 계층형 쿼리를 사용하여 댓글을 올바르게 정렬합니다. -->
    <select id="selectCommentsByBoardNo" parameterType="int" resultType="com.community.mbti.vo.CommentsVO">
        /* selectCommentsByBoardNo */
        SELECT
            commentno, content, mgrno, recommendation, opposition,
            viewcheck, board_boardno, member_mid, "level", wrdate, mbti_idx
        FROM
            COMMENTS
        WHERE
            board_boardno = #{boardno}
          START WITH
            mgrno = 0
        CONNECT BY
            PRIOR commentno = mgrno
        ORDER SIBLINGS BY
            wrdate ASC
    </select>

    <!-- [추가] 특정 게시물의 사진 목록 조회 -->
    <select id="selectPicturesByBoardNo" parameterType="int" resultType="com.community.mbti.vo.PictureVO">
        /* selectPicturesByBoardNo */
        SELECT *
        FROM PICTURE
        WHERE board_boardno = #{boardno}
    </select>

    <!-- [추가] 게시물 추천수 1 증가 -->
    <update id="incrementBoardRecommendation" parameterType="int">
        /* incrementBoardRecommendation */
        UPDATE BOARD
        SET recommendation = recommendation + 1
        WHERE boardno = #{boardno}
    </update>

    <!-- 로그인 사용자의 MBTI 및 관계에 따른 주간 인기글 조회 -->
    <select id="selectWeeklyPopularBoards" resultType="com.community.mbti.vo.BoardVO">
        /* selectWeeklyPopularBoards */
        SELECT *
        FROM (
                 SELECT
                     boardno, title, category, recommendation
                 FROM
                     BOARD
                 WHERE
                     viewcheck = 'Y'
                   AND wrdate >= SYSDATE - 7
                   AND (
                     mbti_idx = #{mbtiIdx} -- 본인 MBTI 게시물
                         OR (category = 1 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'relation_good'))
                         OR (category = 2 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'relation_bad'))
                         OR (category = 3 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'love_good'))
                         OR (category = 4 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{mbtiIdx} AND relation_type = 'love_bad'))
                     )
                 ORDER BY
                     recommendation DESC
             )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <insert id="insertPicture" parameterType="com.community.mbti.vo.PictureVO">
        /* insertPicture */
        INSERT INTO PICTURE (pictureno, picturepath, board_boardno)
        VALUES (PICTURE_SEQ.NEXTVAL, #{picturepath}, #{boardBoardno})
    </insert>

    <!-- [추가] 게시물 논리적 삭제 -->
    <update id="updateBoardViewCheck" parameterType="int">
        /* updateBoardViewCheck */
        UPDATE BOARD
        SET viewcheck = 'N'
        WHERE boardno = #{boardno}
    </update>

    <!-- [수정] 검색 결과 게시물 수 조회 -->
    <select id="selectSearchBoardCount" resultType="int">
        /* selectSearchBoardCount */
        SELECT COUNT(*)
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND title LIKE '%' || #{keyword} || '%'
        <choose>
            <!-- 홈 검색 (category가 null) -->
            <when test="category == null">
                AND (
                mbti_idx = #{userMbti}
                OR (category = 1 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'relation_good'))
                OR (category = 2 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'relation_bad'))
                OR (category = 3 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'love_good'))
                OR (category = 4 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'love_bad'))
                )
            </when>
            <!-- 게시판 내 검색 -->
            <otherwise>
                AND category = #{category}
                <if test="mbtiList != null and !mbtiList.isEmpty()">
                    AND mbti_idx IN
                    <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                        #{mbti}
                    </foreach>
                </if>
            </otherwise>
        </choose>
    </select>

    <!-- [수정] 검색 결과 게시물 목록 조회 (페이징) -->
    <select id="selectSearchBoardList" resultType="com.community.mbti.vo.BoardVO">
        /* selectSearchBoardList */
        SELECT *
        FROM (
        SELECT ROWNUM AS rn, b.*
        FROM (
        SELECT boardno, title, member_mid, wrdate, recommendation, count, mbti_idx, category
        FROM BOARD
        WHERE viewcheck = 'Y'
        AND title LIKE '%' || #{keyword} || '%'
        <choose>
            <when test="category == null">
                AND (
                mbti_idx = #{userMbti}
                OR (category = 1 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'relation_good'))
                OR (category = 2 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'relation_bad'))
                OR (category = 3 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'love_good'))
                OR (category = 4 AND mbti_idx IN (SELECT mbti_to FROM MBTI_RELATIONS WHERE mbti_from = #{userMbti} AND relation_type = 'love_bad'))
                )
            </when>
            <otherwise>
                AND category = #{category}
                <if test="mbtiList != null and !mbtiList.isEmpty()">
                    AND mbti_idx IN
                    <foreach item="mbti" collection="mbtiList" open="(" separator="," close=")">
                        #{mbti}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        ORDER BY boardno DESC
        ) b
        )
        WHERE rn BETWEEN #{paging.startNum} AND #{paging.endNum}
    </select>

</mapper>