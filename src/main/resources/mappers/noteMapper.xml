<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.community.mbti.mapper.NoteMapper">
    <insert id="insertNote" parameterType="com.community.mbti.vo.NoteVO">
        INSERT INTO NOTE (noteno, content, member_mid, recipients, re_mbti)
        VALUES (NOTE_SEQ.NEXTVAL, #{content, jdbcType=VARCHAR}, #{memberMid, jdbcType=VARCHAR}, #{recipients, jdbcType=VARCHAR}, #{reMbti, jdbcType=VARCHAR})
    </insert>

    <select id="selectUnreadNotes" resultType="com.community.mbti.vo.NoteVO">
        SELECT * FROM (
                          SELECT n.noteno, n.content, n.member_mid, n.wrdate, m.mbti_idx as senderMbti
                          FROM NOTE n JOIN MEMBER m ON n.member_mid = m.mid
                          WHERE n.recipients = #{memberId} AND n.read_check = 'N'
                          ORDER BY n.wrdate DESC
                      ) WHERE ROWNUM &lt;= #{limit}
    </select>

    <!-- [추가] 받은 쪽지 총 개수 조회 -->
    <select id="selectReceivedNotesCount" resultType="int">
        /* selectReceivedNotesCount */
        SELECT COUNT(*)
        FROM NOTE
        WHERE recipients = #{memberId}
    </select>

    <!-- [수정] 페이징 처리된 모든 쪽지 목록 조회 -->
    <select id="selectAllReceivedNotes" resultType="com.community.mbti.vo.NoteVO">
        /* selectAllReceivedNotes */
        SELECT *
        FROM (
                 SELECT ROWNUM as rn, n.*, m.mbti_idx as senderMbti
                 FROM (
                          SELECT noteno, content, member_mid, wrdate, read_check
                          FROM NOTE
                          WHERE recipients = #{memberId}
                          ORDER BY wrdate DESC
                      ) n
                          JOIN MEMBER m ON n.member_mid = m.mid
             )
        WHERE rn BETWEEN #{paging.startNum} AND #{paging.endNum}
    </select>

    <select id="selectNoteByNo" resultType="com.community.mbti.vo.NoteVO">
        SELECT * FROM NOTE WHERE noteno = #{noteno}
    </select>

    <update id="markNoteAsRead">
        UPDATE NOTE SET read_check = 'Y' WHERE noteno = #{noteno}
    </update>
</mapper>